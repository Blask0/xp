<div data-live-edit-type="window" data-live-edit-key="72" data-live-edit-name="Canvas: 3D Circle Animation">
    <div id="canvas-3d-circle" style="background-color:#000" class="frame clear clearfix">
        <!-- Placeholder -->
    </div>
    <script type="text/javascript">

        var __3d_canvas = document.createElement('canvas'),
                canvas_3d_width = __3d_canvas.width = 950,
                canvas_3d_height = __3d_canvas.height = 380,
                canvas_3d_halfWidth = canvas_3d_width / 2,
                canvas_3d_halfHeight = canvas_3d_height / 2,
                canvas_3d_fov = 450,
                canvas_3d_mouseX = 120,
                canvas_3d_mouseY = 73;

        var canvas_3d_context = __3d_canvas.getContext('2d');
        document.getElementById('canvas-3d-circle').appendChild(__3d_canvas);
        document.getElementById('canvas-3d-circle').addEventListener("mousemove", onMouseMove);


        // set up a torus shape of pixels
        var canvas_3d_pixels = [];

        for (var canvas_3d_i = 0; canvas_3d_i < Math.PI * 2 - 0.0001; canvas_3d_i += Math.PI / 90) {

            for (var canvas_3d_j = 0; canvas_3d_j < Math.PI * 2 - 0.0001; canvas_3d_j += Math.PI / 24) {

                var canvas_3d_pixel = new Pixel3D(40, 0, 0);
                canvas_3d_pixel.rotateZ(canvas_3d_j);
                canvas_3d_pixel.x += 120;
                canvas_3d_pixel.rotateY(canvas_3d_i);
                canvas_3d_pixels.push(canvas_3d_pixel);

            }
        }


        // call the render function 30 times a second
        setInterval(render, 1000 / 30);


        function render() {

            // clear the canvas
            canvas_3d_context.clearRect(0, 0, canvas_3d_width, canvas_3d_height);
            // and get the imagedata out of it
            var imagedata = canvas_3d_context.getImageData(0, 0, __3d_canvas.width, __3d_canvas.height);

            // iterate through every point in the array
            var i = canvas_3d_pixels.length;
            while (i--) {
                var pixel = canvas_3d_pixels[i];

                // here's the 3D to 2D formula, first work out
                // scale for that pixel's z position (distance from
                // camera)
                var scale = canvas_3d_fov / (canvas_3d_fov + pixel.z);
                // and multiply our 3D x and y to get our
                // 2D x and y. Add halfWidth and halfHeight
                // so that our 2D origin is in the middle of
                // the screen.
                var x2d = (pixel.x * scale) + canvas_3d_halfWidth;
                var y2d = (pixel.y * scale) + canvas_3d_halfHeight;

                // and add the pixel colour to whatever's there
                // already
                additiveBlendPixel(imagedata, x2d, y2d, 150, 0, 200);

                // now rotate each 3d pixel around the origin
                // dependent on the mouse position
                pixel.rotateX(canvas_3d_mouseY * 0.0001);
                pixel.rotateY(canvas_3d_mouseX * 0.0001);


            }

            // and write all those pixel values into the canvas
            canvas_3d_context.putImageData(imagedata, 0, 0);

        }

        function additiveBlendPixel(imagedata, x, y, r, g, b) {

            if ((x < 0) || (x > canvas_3d_width) || (y < 0) || (y > canvas_3d_width)) {
                return;
            }

            var i = ((y >> 0) * imagedata.width + (x >> 0)) * 4;

            r = (imagedata.data[i] + r);
            g = (imagedata.data[i + 1] + g);
            b = (imagedata.data[i + 2] + b);

            imagedata.data[i] = r;
            imagedata.data[i + 1] = g;
            imagedata.data[i + 2] = b;
            imagedata.data[i + 3] = 255;
        }

        function Pixel3D(x, y, z) {
            this.x = x;
            this.y = y;
            this.z = z;

            this.rotateY = function (angle) {

                cosRY = Math.cos(angle);
                sinRY = Math.sin(angle);

                var tempz = this.z;
                ;
                var tempx = this.x;

                this.x = (tempx * cosRY) + (tempz * sinRY);
                this.z = (tempx * -sinRY) + (tempz * cosRY);


            };
            this.rotateX = function (angle) {

                var cosRY = Math.cos(angle);
                var sinRY = Math.sin(angle);

                var tempz = this.z;
                ;
                var tempy = this.y;

                this.y = (tempy * cosRY) + (tempz * sinRY);
                this.z = (tempy * -sinRY) + (tempz * cosRY);


            };

            this.rotateZ = function (angle) {

                var cosRY = Math.cos(angle);
                var sinRY = Math.sin(angle);

                var tempx = this.x;
                ;
                var tempy = this.y;

                this.y = (tempy * cosRY) + (tempx * sinRY);
                this.x = (tempy * -sinRY) + (tempx * cosRY);


            };
        }


        function onMouseMove(e) {
            canvas_3d_mouseX = (canvas_3d_halfWidth - e.clientX);
            canvas_3d_mouseY = (canvas_3d_halfHeight - e.clientY);

        }
    </script>
</div>


